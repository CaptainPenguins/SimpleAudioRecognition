#include <math.h>
#include <stdlib.h>

#include "fft.h"

//#include "../test_audio_fft.h"
//#include "../test_audio.h"

// this function only handles real-value discrete FFT of
// n = 512, k = 257
float* compute_fft(float* values, XAxiDma AxiDmaFFT){

	//xil_printf("\r\nComputing FFT");

	// Peter's test audio
	/*for (int i = 0; i < 512; i++){
		int temp = peter_fft_test[i];
		if (temp & 0x8000){
			temp |=  ~0xffff;
		}
		values[i] = temp;

		int whole2 = values[i];
		int thousandths2 = (values[i] - whole2) * 1000;
		//xil_printf("\r\nConverted: %d.%03d", whole2, thousandths2);
	}*/

	// We scale down values sent into FFT IP to avoid overflowing
	// Only HARDWARE input need to be scaled. We DO NOT scale software input
	//xil_printf("\r\nProcessing input");
	int* fftInput = (unsigned int*)malloc(FFT_N * sizeof(int));
	int overflow_count = 0;
	for (int i = 0; i < FFT_N; i++){
		int temp = values[i] / SCALE_DOWN;

		if (temp > SIGNED_SHORT_MAX){
			temp = SIGNED_SHORT_MAX;
			overflow_count++;
		} else if (temp < -SIGNED_SHORT_MAX){
			temp = -SIGNED_SHORT_MAX;
			overflow_count++;
		}

		fftInput[i] = temp;
	}
	//xil_printf("\r\nOverflow count: %d", overflow_count);

	// Using my FFT
	float* matmul_fft = fft_with_matmul(values);

	// Using FFT IP
	//float* ip_fft = fft_with_ip(fftInput, AxiDmaFFT);

	//fft_result_compare(matmul_fft, ip_fft);

	//xil_printf("\r\nFFT finished");
    //return ip_fft;
	return matmul_fft;
}


float* fft_with_matmul(float* input) {
	//xil_printf("\r\nReal");
	float** real_part = matmul_special(&input, 1, FFT_N, COS_COEFFS, FFT_K, FFT_N);
	//xil_printf("\r\nComplex");
	float** comp_part = matmul_special(&input, 1, FFT_N, SIN_COEFFS, FFT_K, FFT_N);

	float* result = (float*)malloc(FFT_K * sizeof(float));

	//xil_printf("\r\nPower");
	for (int i = 0; i < FFT_K; i++){
		result[i] = (	real_part[0][i] * real_part[0][i] + 
						comp_part[0][i] * comp_part[0][i]) 
					/ FFT_N;
	}
	//print_1d_float(result, 1, FFT_K);

	return result;
}


float* fft_with_ip(int* input, XAxiDma AxiDmaFFT) {

	float* result = (float*)malloc(FFT_K * sizeof(float));
	int* resultInt = (int*)malloc(1024 * sizeof(int));

	//xil_printf("\r\nHanding over to hardware FFT");
	DMA_FFT(input, resultInt, AxiDmaFFT);
	//xil_printf("\r\nFFT testing Complete");

	//xil_printf("\r\nPost-processing hardware FFT");
	for (int i = 0; i < FFT_N; i = i + 1) {
		int real, imaginary;
		float power;
		real = resultInt[2 * i];
		imaginary = resultInt[2 * i + 1];
		result[i] = (float)real * (float)real + (float)imaginary * (float)imaginary;
		result[i] = result[i] / HW_SCALE * 256;		// 2 = div 512, mul 256
		//xil_printf("\r\n%d, %d, %d",i, real, imaginary);
	}

	return result;
}

void fft_result_compare(float* matmul_fft, float* ip_fft) {
	for (int i = 0; i < FFT_K; i++){
		xil_printf("\r\n(%03d) IP: ", i);
		int decimals = print_float(ip_fft[i]);
		xil_printf(", SW: ");
		print_float_fixed(matmul_fft[i], decimals);
		xil_printf(", RATIO: ");
		print_float(ip_fft[i] / matmul_fft[i]);
	}
}


float test_x[512] = {
	63.2756163887   , 43.6850148118   , 24.5561694425   , 54.7529086698   , 44.5468209823   , 90.9541921329   ,
	4.89140733918   , 83.8455485955   , 21.5034386601   , 89.0540320901   , 10.5696584333   , 32.6559445091   ,
	29.7610403022   , 1.65094669487   , 51.1979758224   , 80.1337120721   , 27.4002711515   , 25.2482427247   ,
	66.2860521471   , 38.4331989388   , 94.4786083688   , 33.0329706448   , 93.8522016137   , 21.0868873987   ,
	74.4043819278   , 95.4164108933   , 86.4514500842   , 42.6007481651   , 87.4985126441   , 23.2860375469   ,
	11.3952531383   , 10.999137844    , 95.3772144824   , 21.6763994748   , 26.0087989393   , 3.38211986319   ,
	1.81182275035   , 64.5527173813   , 48.7642361579   , 43.9842370739   , 99.2559955237   , 73.321269777    ,
	67.4606641379   , 12.9752611928   , 16.8509372643   , 40.6821098514   , 80.2115764175   , 37.4476961827   ,
	52.2285745525   , 9.03061568683   , 6.54801156796   , 16.3583100872   , 42.3128669927   , 24.3590234163   ,
	99.2911619055   , 45.3073454472   , 18.4055083749   , 16.4484319177   , 19.7342726867   , 92.0119577403   ,
	67.9840645022   , 82.4799401664   , 43.4283959678   , 40.0839997517   , 9.51652875858   , 53.2126173218   ,
	91.2169986147   , 76.63450612     , 92.3515725802   , 88.5826755288   , 48.4751003826   , 67.8292172346   ,
	1.86733639709   , 66.1787924723   , 43.6495861828   , 68.0140568524   , 76.3492118149   , 98.2037926527   ,
	70.6470264674   , 50.8531773369   , 3.25307980972   , 84.8163233301   , 42.5071050028   , 32.5276964647   ,
	89.4003121787   , 24.0400050731   , 60.676921779    , 32.3511822851   , 63.5966846492   , 79.947176701    ,
	63.7390654632   , 51.711675224    , 67.1023211527   , 49.6287587284   , 70.3934675637   , 23.963316242    ,
	24.570644036    , 58.6225358314   , 64.5314359496   , 12.861808143    , 9.11616661654   , 86.2498346352   ,
	36.9890165273   , 35.7328058495   , 24.6471688645   , 31.4984698791   , 41.8595418912   , 88.0572998755   ,
	16.5197871301   , 70.2818158087   , 17.1444487336   , 47.8345346409   , 6.59969750968   , 79.5281967853   ,
	95.776833048    , 30.6297643736   , 20.9360463956   , 40.1567977868   , 63.243457929    , 41.5158080084   ,
	92.5131839839   , 79.3009321627   , 27.2810127127   , 34.1041564718   , 54.9331327992   , 42.1067181571   ,
	67.2960730228   , 86.3845274656   , 66.8625576754   , 14.4845344516   , 95.6273893236   , 94.5930285372   ,
	49.5711198237   , 98.1654239553   , 87.6194622097   , 67.5110459842   , 77.4907874231   , 28.5847759342   ,
	91.2734430031   , 6.85068015857   , 89.0618550248   , 21.4605387758   , 23.9923104382   , 96.0753539766   ,
	28.0144848621   , 67.8058351684   , 79.9952512673   , 63.0720284033   , 21.3297416192   , 29.6623069629   ,
	66.5666584026   , 71.0744054691   , 44.0618201352   , 88.763691603    , 21.2435402928   , 95.5773489181   ,
	13.5154665846   , 13.5651987142   , 83.4417710473   , 7.46194410743   , 74.0731539167   , 2.60683725543   ,
	34.4703582116   , 68.9719729137   , 70.7789600626   , 50.8532090179   , 19.8098336298   , 24.5191751431   ,
	35.2948982345   , 76.5703192742   , 16.9602903988   , 87.4583784521   , 73.4216541535   , 61.1269301393   ,
	35.5699918998   , 62.2550870987   , 30.2306573148   , 49.7310159312   , 46.9053660928   , 70.0352269792   ,
	65.0643947772   , 10.248271914    , 80.8972622889   , 32.842343335    , 61.2282253924   , 48.5452942572   ,
	95.2924335474   , 72.6180592146   , 93.1033949027   , 31.0384882954   , 82.6697785918   , 36.8044712814   ,
	83.3124979138   , 39.9182884463   , 19.8467449379   , 30.2637829463   , 43.2925634438   , 32.8628872359   ,
	87.2425684918   , 80.088299665    , 38.3745752408   , 16.9291297653   , 8.59214831278   , 97.0851262376   ,
	73.9142408197   , 11.3954792685   , 62.4178234235   , 70.2512335668   , 89.3277060445   , 97.7780694356   ,
	75.7625585913   , 76.0039421362   , 62.6542295676   , 69.3312989134   , 42.0406192971   , 34.6651666938   ,
	15.7683607679   , 81.0559395086   , 46.8486255155   , 59.598144482    , 54.2425752088   , 54.4929983607   ,
	11.2989577345   , 66.9820715452   , 87.9667124724   , 56.1389175111   , 38.6834757828   , 82.0818134583   ,
	50.72224289     , 94.7936939027   , 48.722405563    , 66.1501048936   , 56.7133099797   , 20.1484606614   ,
	37.7243138233   , 41.5407112155   , 72.3171042937   , 74.7589111223   , 49.6689963948   , 11.0757481536   ,
	30.7779797852   , 54.0341506301   , 35.4636947913   , 67.8112236412   , 85.1083351582   , 38.2494857916   ,
	7.78425204569   , 19.0948987229   , 22.4879055586   , 82.0023214475   , 10.4615317305   , 55.5496467436   ,
	43.7597825096   , 96.6988987391   , 93.3602464026   , 87.8977075851   , 90.1912019323   , 7.95836602672   ,
	37.7472261336   , 42.7710105937   , 4.68590592356   , 48.6500558841   , 22.2362264476   , 45.9999547562   ,
	48.866541314    , 77.9807011276   , 10.2060824547   , 18.7549132476   , 44.6269114722   , 19.8699376517   ,
	68.1420286075   , 85.1153053328   , 92.8493467956   , 15.0654981156   , 39.5376290995   , 58.0764397821   ,
	47.1981651089   , 27.3065716336   , 10.0305354874   , 70.2820299684   , 40.4081112709   , 83.6227845321   ,
	27.0443748425   , 72.8994961888   , 45.0049579511   , 75.0005227035   , 69.7891456156   , 87.4788791182   ,
	87.1187693778   , 14.5677464769   , 74.0411908373   , 54.9638001775   , 54.787023647    , 86.486399815    ,
	22.222362387    , 15.1656624065   , 84.6439951434   , 16.7572650083   , 29.5515678602   , 32.8767553677   ,
	32.7668151826   , 28.0678208334   , 86.5647793571   , 52.390591603    , 10.2964295887   , 77.7163016801   ,
	98.6845120175   , 16.7961709223   , 73.9199269623   , 71.5879135296   , 56.3267873805   , 25.0453572081   ,
	20.886053789    , 60.6607898106   , 6.97656484556   , 64.0800358918   , 62.2885400091   , 4.45675633074   ,
	13.2459349368   , 31.85358061     , 21.517886002    , 57.0152523947   , 8.46385873284   , 59.2612787627   ,
	15.821570632    , 57.0856042882   , 87.7639842665   , 52.1919650429   , 60.2212084079   , 4.65081460289   ,
	24.1769338896   , 18.9704305599   , 83.9054615688   , 52.4067226047   , 38.2363635894   , 60.3580814786   ,
	15.3886199144   , 60.9309785246   , 90.9343196492   , 48.3849857892   , 84.1817285815   , 83.8190883519   ,
	60.4704773902   , 49.8725346158   , 79.768928496    , 38.8537078071   , 52.3877661727   , 59.172674615    ,
	73.7073734454   , 81.5707787124   , 79.9127030669   , 77.8135212364   , 38.6810004665   , 74.1846416939   ,
	76.5163777589   , 19.0928746449   , 18.7080837171   , 58.915944201    , 33.0962598699   , 58.5823967397   ,
	80.447853969    , 5.89729215682   , 11.4121520789   , 49.9281774929   , 23.1683281496   , 65.4031388645   ,
	5.53441206992   , 96.8078830862   , 30.2855064706   , 73.9467554797   , 17.6386857106   , 91.7219823999   ,
	27.6173756369   , 6.52865819116   , 2.62463593732   , 81.6308527443   , 7.16519274356   , 48.3483013203   ,
	31.5407114688   , 42.0383687752   , 91.4814860104   , 89.4018851731   , 85.4022313205   , 96.1418793085   ,
	70.8910043201   , 15.471902137    , 83.0935715749   , 32.650528439    , 36.6903354924   , 38.4747405788   ,
	67.7992263863   , 78.4210499876   , 53.1590983934   , 50.811842732    , 52.3919870302   , 2.86998020983   ,
	53.4426579836   , 24.7450011294   , 55.6988715508   , 25.812914412    , 67.9634185066   , 42.8421988649   ,
	49.706147508    , 87.1478857766   , 69.7325023011   , 17.6523255206   , 96.1696502338   , 21.7822935433   ,
	51.5905558403   , 72.0151408056   , 33.8119037531   , 65.6085206992   , 13.9754076785   , 1.56781406187   ,
	12.8730512761   , 89.7098118867   , 64.9202685562   , 24.5671466279   , 39.8492028844   , 25.3717378013   ,
	75.4706213727   , 23.4147405784   , 85.7583852432   , 4.00981814565   , 84.757462232    , 9.13344976575   ,
	35.0571263066   , 58.0125094363   , 63.1381647092   , 96.6059693039   , 51.3992588674   , 14.9665067881   ,
	19.0792942638   , 70.7136854612   , 46.8244457967   , 93.8801378654   , 90.8335153361   , 48.3082685846   ,
	95.9784076758   , 10.0576291434   , 16.3418404403   , 62.1596008667   , 25.3532162733   , 77.3157399154   ,
	20.5503190874   , 27.041542617    , 73.5700327214   , 44.966536278    , 29.2129616592   , 28.7299892836   ,
	54.127813517    , 53.337171597    , 3.09252926012   , 73.7080236952   , 28.5897281319   , 80.5145668535   ,
	98.4450166409   , 54.9195735742   , 97.0615936734   , 79.288192839    , 53.1617929779   , 39.9166080538   ,
	59.0583641289   , 43.5536364999   , 70.7904790602   , 20.5892769755   , 87.2411689743   , 25.5247479234   ,
	94.7554967516   , 43.3078707966   , 36.1049649515   , 51.8181394483   , 77.5795910985   , 63.9819075911   ,
	45.0480160134   , 59.9059261806   , 4.73891699826   , 26.0139017473   , 58.8523746453   , 81.5415573339   ,
	11.3322196605   , 93.1555723609   , 50.0723994438   , 74.7585399002   , 37.4567817538   , 52.712295177    ,
	73.2009333898   , 27.7515991315   , 22.9432428524   , 90.5228869221   , 16.5918451604   , 6.49730879449   ,
	0.884349604921  , 59.5660290817   , 33.3160379641   , 46.0211640558   , 44.147550551    , 34.4266023175   ,
	42.3609477239   , 27.7346726923   , 69.4288566892   , 28.5710890356   , 11.2341284911   , 99.4661325929   ,
	86.5595701756   , 25.9902180606   , 27.8776672343   , 25.6677491742   , 0.386137128593  , 24.8549626501   ,
	40.4119259225   , 33.1294730652 };
